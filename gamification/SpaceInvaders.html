<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <title>Space Invaders Ping Pong</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import { initializeApp } from "./game.js";

      const ws = new WebSocket("ws://localhost:3001");
      
      let eventDataValue = 0;

      import hitCheck from "./functions.js";

      (async () => {
        const { app, updateHealthDisplay } = await initializeApp();

        // Load game assets
        await PIXI.Assets.init();
        const textures = await PIXI.Assets.load([
          "./images/monster.png",
          "./images/eld.png",
          "./images/shroomHouse2.png",
          "./images/lifebar4.png",
          "./images/lifebar3.png",
          "./images/lifebar2.png",
          "./images/lifebar1.png",
          "./images/lifebar1.png",
          "./images/yellowMarker.png",
          "./images/shroomHouse2.png",
        ]);

        // Game objects
        const alien = new PIXI.Sprite(
          textures["./images/monster.png"]
        );
        alien.anchor.set(0.5);
        alien.width = 240;
        alien.height = 160;
        alien.position.set(app.screen.width / 2, 100);
        app.stage.addChild(alien);

        const tower = new PIXI.Sprite(textures["./images/shroomHouse2.png"]);
        tower.anchor.set(0.5);
        tower.width = 80 * 2;
        tower.height = 120 * 2;
        tower.position.set(app.screen.width / 2, app.screen.height - 80);

        tower.scale.set(0.04); // Scale the tower to make it smaller
        app.stage.addChild(tower);

        // Game state
        let alienHealth = 4;
        updateHealthDisplay(alienHealth);
        const hitMarkers = [];
        const activeLasers = [];

        // Tower health display
        let towerHealth = 100;
        const towerHealthText = new PIXI.Text({
          text: `Tower Health: ${towerHealth}`,
          style: {
            fontFamily: "Arial",
            fontSize: 24,
            fill: 0xffffff,
          },
        });
        towerHealthText.x = 20;
        towerHealthText.y = 20;
        app.stage.addChild(towerHealthText);

        // Laser function
        const createLaser = () => {
          if (alienHealth <= 0) return;

          const laser = new PIXI.Sprite(textures["./images/eld.png"]);
          laser.anchor.set(0.5);
          laser.width = 120;
          laser.height = 60;
          laser.position.set(alien.x, alien.y + 40);
          app.stage.addChild(laser);
          activeLasers.push(laser);
        };

        // Automatic shooting
        const shootInterval = setInterval(createLaser, 2000);

        // WebSocket handler for hit coordinates
        ws.onmessage = (event) => {
          let eventDataValue = event.data;
          console.log("Received coordinates:", eventDataValue);

          let match = eventDataValue.match(/X(\d+).*Y(\d+)/i);

          let xCoord = 0;
          let yCoord = 0;
          if (match) {
            xCoord = parseInt(match[1]);
            yCoord = parseInt(match[2]);
            console.log(
              `Parsed game coordinates: (x = ${xCoord}, y = ${yCoord})`
            );
          } else{
            console.error("failed to parse coords:", 
              eventDataValue
            );
          }

          // Normalize to screen width/height
         

          // Create hit marker
          const marker = new PIXI.Sprite(textures["./images/yellowMarker.png"]);
          marker.anchor.set(0.5);
          marker.width = 30;
          marker.height = 30;
          marker.position.set(x, y);
          app.stage.addChild(marker);

          // Check hit on alien
          const alienBounds = alien.getBounds();
          if (
            hitCheck(marker, alien)
          ) {
            alienHealth--;
            updateHealthDisplay(alienHealth);

            ws.send(
              JSON.stringify({
                type: "ALIEN_HIT",
                health: alienHealth,
              })
            );
          }

          // Remove marker after a delay
          setTimeout(() => {
            if (marker.parent) {
              app.stage.removeChild(marker);
            }
          }, 500);
        };

        // Game loop
        let alienDirection = 1;
        app.ticker.add(() => {
          // Alien movement
          if (alienHealth > 0) {
            alien.x += 2 * alienDirection;
            if (alien.x > app.screen.width - 50 || alien.x < 50) {
              alienDirection *= -1;
            }
          }

          // Laser movement
          for (let i = activeLasers.length - 1; i >= 0; i--) {
            const laser = activeLasers[i];
            laser.y += 8;

            // Tower collision
            if (
              laser.y >= tower.y - tower.height / 2 &&
              laser.x >= tower.x - tower.width / 2 &&
              laser.x <= tower.x + tower.width / 2
            ) {
              app.stage.removeChild(laser);
              activeLasers.splice(i, 1);

              // Update tower health
              towerHealth -= 10;
              towerHealthText.text = `Tower Health: ${towerHealth}`;
              ws.send("TOWER_HIT");

              if (towerHealth <= 0) {
                tower.texture = PIXI.Texture.from("./images/virus_dead.png");
                towerHealthText.text = "Tower Destroyed!";
                clearInterval(shootInterval);
              }
              continue;
            }

            // Remove off-screen lasers
            if (laser.y > app.screen.height) {
              app.stage.removeChild(laser);
              activeLasers.splice(i, 1);
            }
          }
        });
      })();
    </script>
  </body>
</html>
