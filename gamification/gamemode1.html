<!-- 
How does it work?


-->

<!DOCTYPE html>
<html>
  <head>
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <script>
      //connecting to the database and saving the score
      const SUPABASE_URL = "https://usvpcmzfwcpkssybobgy.supabase.co"; // Replace with your URL
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzdnBjbXpmd2Nwa3NzeWJvYmd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1MTkzNzIsImV4cCI6MjA2MjA5NTM3Mn0.vWPc9AXRODxhBQP14iQID75i3SZRZZZ1mX_WwlN_cQM"; // Replace with your anon key

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      //now the db is connected
    </script>

    <section id="gameOver">
      <form id="scoreForm">
        <label for="playerName">Name:</label>
        <input type="text" id="playerName" name="playerName" required />
        <button type="submit">Save Score</button>
      </form>
      <a href="index.html">Hem</a>
    </section>

    <script>
      function saveScore(finalScore) {
        const form = document.getElementById("scoreForm");

        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          const playerName = document.getElementById("playerName").value;
          //const score = targetCounter; // Assuming targetCounter holds the score

          try {
            const { data, error } = await client
              .from("Leaderboard")
              .insert([{ name: playerName, points: finalScore }]);

            if (error) {
              console.error("Error saving score:", error);
            } else {
              console.log("Score saved successfully:", data);
              alert("Score saved successfully!");
            }
          } catch (err) {
            console.error("Unexpected error:", err);
          }

          form.style.pointerEvents = "none";
        });
      }
    </script>
    <!-- <h1>Spelifierad <br />bordtennisträning</h1>
    <h1>hej</h1>
    <nav><a href="getCoords.html"></a></nav> -->

    <script type="module">
      //setting up the websocket
      //WebSocket-anslutning, öppnas till server på local port 8080
      const ws = new WebSocket("ws://localhost:8080");

      let eventDataValue = 0;

      // importing the stage
      import {
        tableWidth,
        tableHeight,
        bgBlue,
        white,
        initializeApp,
      } from "./common.js";

      //importera functions
      import {
        changeTexture,
        changeTextureTemporarily,
        hitCheck,
        generateRandomCoordinates,
        moveSprite,
        countdownClock,
        closePixiWindow,
      } from "./functions.js";

      function hello() {
        console.log("hello");
      }

      (async () => {
        const { app, scoreText, updateScoreText } = await initializeApp();

        //-------------------------GAMECODE GOES HERE--------------------------
        //load images and set them as variables
        await PIXI.Assets.load("images/virus.png");
        await PIXI.Assets.load("images/virus_dmg.png");
        await PIXI.Assets.load("images/virus_dead.png");

        const virusTex = PIXI.Texture.from("images/virus.png");
        const virus_dmgTex = PIXI.Texture.from("images/virus_dmg.png");
        const virus_deadText = PIXI.Texture.from("images/virus_dead.png");

        // Create the target and add it to the stage
        let target = new PIXI.Sprite(virusTex);
        target.scale.set(0.5, 0.5); // Scale the target to half its size
        app.stage.addChild(target);

        // Create the marker
        await PIXI.Assets.load("images/yellowMarker.png");
        let marker = PIXI.Sprite.from("images/yellowMarker.png");

        // Create a smaller marker
        await PIXI.Assets.load("images/yellowMarker.png");
        let smallMarker = PIXI.Sprite.from("images/yellowMarker.png");
        smallMarker.scale.set(0.5, 0.5); // Scale the marker to half its size

        //-------------------------------------------------------------------------------------------------
        // GAMIFICATION
        //-------------------------------------------------------------------------------------------------

        let targetCounter = 0;
        target.interactive = true;
        target.buttonMode = true;

        //körs när meddelande tas emot från ws server
        ws.onmessage = function (event) {
          let eventDataValue = event.data; // Convert event.data to an integer

          let [xCoord, yCoord] = eventDataValue.split(",").map(Number);
          smallMarker.x = xCoord - smallMarker.width / 2;
          smallMarker.y = yCoord - smallMarker.height / 2;
          app.stage.addChild(smallMarker);
          hitCheck(target, xCoord, yCoord);

          setTimeout(() => {
            app.stage.removeChild(smallMarker);
          }, 1000);
          console.log(eventDataValue);
        };

        //kör när meddelande inte tas emot
        ws.onerror = function (err) {
          console.error("WebSocket error:", err);
        };

        // When the player clicks the target
        target.on("pointerdown", () => {
          target.interactive = false; // Make the target unclickable
          setTimeout(() => {
            target.interactive = true; // Re-enable clicking after 0.5 seconds
          }, 500);

          targetCounter += 1;
          updateScoreText(targetCounter);

          if (targetCounter % 5 == 0) {
            // Move the target to a new random position
            let [newTargetPosX, newTargetPosY] = generateRandomCoordinates();

            // Set a new position for the target

            changeTextureTemporarily(target, virus_deadText);
            setTimeout(() => {
              target.x = newTargetPosX;
              target.y = newTargetPosY;
              moveSprite(target, newTargetPosX, newTargetPosY);
            }, 500);
          } else {
            changeTextureTemporarily(target, virus_dmgTex);
          }
        });

        // Make the window clickable
        window.addEventListener("click", onClick);

        function onClick(event) {
          // Get the mouse coordinates relative to the Pixi.js canvas
          let rect = app.view.getBoundingClientRect();
          let x = event.clientX - rect.left;
          let y = event.clientY - rect.top;

          if (hitCheck(target, x, y)) {
            console.log("You hit the target!");
          } else {
            // Missed shot
            marker.x = x - marker.width / 2;
            marker.y = y - marker.height / 2;

            app.stage.addChild(marker);

            setTimeout(() => {
              app.stage.removeChild(marker);
            }, 1000);

            console.log(`Mouse clicked at x: ${x}, y: ${y}`);
          }
        }

        // Function to close down the PixiJS app
        let finalScore = 0;
        function closeApp() {
          finalScore = targetCounter;
          window.removeEventListener("click", onClick);
          app.destroy(true, {
            children: true,
            texture: true,
            baseTexture: true,
          });

          console.log("PixiJS app has been closed.");

          saveScore(finalScore);
        }
        console.log(finalScore);

        //counting down and then closing the window
        //how much time do you want to play?
        let minutes = 2;
        let seconds = 0;
        // Create a text object to display the countdown timer
        const timerText = new PIXI.Text(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, {
          fontFamily: 'Arial',
          fontSize: 36,
          fill: 'white',
        });
        timerText.x = app.view.width - 100; // Position it on the top-right corner
        timerText.y = 20;
        app.stage.addChild(timerText);

        // Update the countdown timer every second
        const timerInterval = setInterval(() => {
          if (seconds === 0) {
            if (minutes === 0) {
              clearInterval(timerInterval); // Stop the timer when it reaches 0
              closeApp(); // Call the closeApp function
              return;
            } else {
              minutes -= 1;
              seconds = 59;
            }
          } else {
            seconds -= 1;
          }

          // Update the timer text
          timerText.text = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }, 1000);
        //countdownClock(minutes, seconds, closeApp);
        


      })();
    </script>
  </body>
</html>
